<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>–ú–∞–ª–æ–†–∏—Å–∞ ‚Äî –ó–º–µ–π–∫–∞</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#111;
  --panel:#1c1c1c;
  --canvas:#000;
  --text:#fff;
  --accent:#ff6b9a;
  --grid:#1a1a1a;
}
body.light{
  --bg:#f3f3f3;
  --panel:#fff;
  --canvas:#e6e6e6;
  --text:#111;
  --grid:#d0d0d0;
}

*{margin:0;padding:0;box-sizing:border-box}
body{
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
  height:100vh;
  touch-action:none;
}

header{
  width:100%;
  padding:12px;
  background:var(--panel);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.title{
  font-family:'Press Start 2P', monospace;
  font-size:14px;
  color:var(--accent);
}

.btn-ui{
  padding:6px 10px;
  border-radius:10px;
  background:#2a2a2a;
  color:#fff;
  user-select:none;
}
body.light .btn-ui{background:#ddd;color:#000}

canvas{
  background:var(--canvas);
  border-radius:14px;
  margin:10px 0;
  image-rendering:pixelated;
}

.controls{
  display:grid;
  grid-template-columns:repeat(3,70px);
  grid-template-rows:repeat(2,70px);
  gap:10px;
}
.btn{
  background:#222;
  border-radius:14px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:28px;
}
body.light .btn{background:#ddd;color:#000}
.btn:active{background:var(--accent)}
.up{grid-column:2}
.left{grid-column:1}
.down{grid-column:2}
.right{grid-column:3}

.overlay{
  position:fixed;
  inset:0;
  background:var(--bg);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:10;
}

.logo{
  font-family:'Press Start 2P', monospace;
  font-size:24px;
  color:var(--accent);
  margin-bottom:30px;
}

.pixel-btn{
  font-family:'Press Start 2P', monospace;
  padding:16px 28px;
  border-radius:14px;
  background:var(--accent);
  color:#000;
}

.small{font-size:12px;margin-top:8px}
</style>
</head>

<body>

<div class="overlay" id="start">
  <div class="logo">–ú–ê–õ–û–†–ò–°–ê</div>
  <div class="pixel-btn" id="play">–ò–ì–†–ê–¢–¨</div>
</div>

<div class="overlay" id="over" style="display:none">
  <div class="logo">GAME OVER</div>
  <div class="small">
    –°—á–µ—Ç: <span id="finalScore">0</span> |
    –†–µ–∫–æ—Ä–¥: <span id="finalRecord">0</span>
  </div>
  <div class="pixel-btn" id="restart">–°–ù–û–í–ê</div>
</div>

<header>
  <span id="score">0</span>
  <span class="title">–ú–ê–õ–û–†–ò–°–ê</span>
  <span style="display:flex;gap:6px">
    <span id="record">0</span>
    <span class="btn-ui" id="sound">üîä</span>
    <span class="btn-ui" id="pause">‚è∏</span>
    <span class="btn-ui" id="theme">‚òÄÔ∏é / üåô</span>
  </span>
</header>

<canvas id="game" width="320" height="320"></canvas>

<div class="controls">
  <div></div><div class="btn up">‚ñ≤</div><div></div>
  <div class="btn left">‚óÄ</div><div class="btn down">‚ñº</div><div class="btn right">‚ñ∂</div>
</div>

<script>
const Game = (() => {
  const canvas = document.getElementById("game")
  const ctx = canvas.getContext("2d")
  ctx.imageSmoothingEnabled = false

  const box = 20
  const cols = canvas.width / box
  const rows = canvas.height / box

  const foods = ["üç£","üçü","üçî","üçï"]

  let snake, dir, food, score, paused=true
  let record = localStorage.getItem("malorisa_record") || 0
  let soundOn = localStorage.getItem("malorisa_sound") !== "0"
  let audioCtx

  document.getElementById("record").innerText = record
  document.getElementById("finalRecord").innerText = record
  document.getElementById("sound").innerText = soundOn ? "üîä" : "üîá"

  const initAudio = () => {
    if(!audioCtx){
      audioCtx = new (window.AudioContext||window.webkitAudioContext)()
    }
  }

  const beep = (freq) => {
    if(!soundOn || !audioCtx) return
    const o = audioCtx.createOscillator()
    const g = audioCtx.createGain()
    o.type="square"
    o.frequency.value=freq
    g.gain.value=0.08
    o.connect(g).connect(audioCtx.destination)
    o.start()
    o.stop(audioCtx.currentTime+0.1)
  }

  const vibrate = () => {
    if(navigator.vibrate) navigator.vibrate(20)
  }

  const spawnFood = () => {
    do{
      food = {
        x:Math.floor(Math.random()*cols),
        y:Math.floor(Math.random()*rows),
        icon:foods[Math.floor(Math.random()*foods.length)]
      }
    }while(snake.some(p=>p.x===food.x&&p.y===food.y))
  }

  const start = () => {
    snake=[{x:10,y:10}]
    dir={x:1,y:0}
    score=0
    paused=false
    document.getElementById("score").innerText=0
    spawnFood()
  }

  const gameOver = () => {
    paused=true
    if(score>record){
      record=score
      localStorage.setItem("malorisa_record",record)
    }
    document.getElementById("finalScore").innerText=score
    document.getElementById("record").innerText=record
    document.getElementById("finalRecord").innerText=record
    document.getElementById("over").style.display="flex"
  }

  const update = () => {
    if(paused) return

    const head={
      x:(snake[0].x+dir.x+cols)%cols,
      y:(snake[0].y+dir.y+rows)%rows
    }

    if(snake.some(p=>p.x===head.x&&p.y===head.y)){
      gameOver()
      return
    }

    snake.unshift(head)

    if(head.x===food.x&&head.y===food.y){
      score++
      document.getElementById("score").innerText=score
      beep(880)
      vibrate()
      spawnFood()
    }else snake.pop()
  }

  const drawGrid = () => {
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--grid')
    for(let i=0;i<cols;i++){
      ctx.beginPath()
      ctx.moveTo(i*box,0)
      ctx.lineTo(i*box,canvas.height)
      ctx.stroke()
    }
    for(let i=0;i<rows;i++){
      ctx.beginPath()
      ctx.moveTo(0,i*box)
      ctx.lineTo(canvas.width,i*box)
      ctx.stroke()
    }
  }

  const drawHeadEyes = (x,y) => {
    const cx = x*box + box/2
    const cy = y*box + box/2
    const ox = dir.x * 4
    const oy = dir.y * 4

    ctx.fillStyle="#fff"
    ctx.beginPath()
    ctx.arc(cx-4+ox, cy-4+oy, 2, 0, Math.PI*2)
    ctx.arc(cx+4+ox, cy-4+oy, 2, 0, Math.PI*2)
    ctx.fill()

    ctx.fillStyle="#000"
    ctx.beginPath()
    ctx.arc(cx-4+ox, cy-4+oy, 1, 0, Math.PI*2)
    ctx.arc(cx+4+ox, cy-4+oy, 1, 0, Math.PI*2)
    ctx.fill()
  }

  const draw = () => {
    ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--canvas')
    ctx.fillRect(0,0,canvas.width,canvas.height)
    drawGrid()

    ctx.font="18px serif"
    ctx.fillText(food.icon, food.x*box+2, food.y*box+18)

    snake.forEach((p,i)=>{
      ctx.fillStyle=i===0?"#ffd1e1":"#ff6b9a"
      ctx.fillRect(p.x*box+1,p.y*box+1,box-2,box-2)
      if(i===0) drawHeadEyes(p.x,p.y)
    })
  }

  setInterval(()=>{update();draw()},150)

  const setDir = (x,y) => {
    if(dir.x!==-x||dir.y!==-y) dir={x,y}
  }

  return { start, setDir, initAudio, beep, toggleSound:()=>{
    soundOn=!soundOn
    localStorage.setItem("malorisa_sound",soundOn?"1":"0")
    document.getElementById("sound").innerText = soundOn?"üîä":"üîá"
  }}
})()

/* controls */
document.querySelector(".up").onpointerdown=()=>Game.setDir(0,-1)
document.querySelector(".down").onpointerdown=()=>Game.setDir(0,1)
document.querySelector(".left").onpointerdown=()=>Game.setDir(-1,0)
document.querySelector(".right").onpointerdown=()=>Game.setDir(1,0)

document.addEventListener("keydown",e=>{
  if(e.key==="ArrowUp"||e.key==="w")Game.setDir(0,-1)
  if(e.key==="ArrowDown"||e.key==="s")Game.setDir(0,1)
  if(e.key==="ArrowLeft"||e.key==="a")Game.setDir(-1,0)
  if(e.key==="ArrowRight"||e.key==="d")Game.setDir(1,0)
})

document.getElementById("play").onpointerdown=()=>{
  Game.initAudio()
  Game.beep(440)
  document.getElementById("start").style.display="none"
  Game.start()
}
document.getElementById("restart").onpointerdown=()=>{
  Game.beep(440)
  document.getElementById("over").style.display="none"
  Game.start()
}

document.getElementById("pause").onpointerdown=()=>{
  Game.setDir(0,0)
}
document.getElementById("sound").onpointerdown=()=>Game.toggleSound()
document.getElementById("theme").onpointerdown=()=>document.body.classList.toggle("light")
</script>
</body>
</html>

